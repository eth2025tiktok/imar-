{
  "name": "seyhan-keos-playwright",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "start": "node server.js"
  },
  "dependencies": {
    "express": "^4.19.2",
    "playwright": "^1.42.0"
  }
}                
                # Hedef parseli bul ve tƒ±kla
                target_text = f"{ada}/{parsel}"
                clicked = False
                
                for link in parsel_links:
                    link_text = link.inner_text()
                    if target_text in link_text:
                        print(f"üéØ Hedef bulundu: {link_text}")
                        link.click()
                        clicked = True
                        break
                
                if not clicked and len(parsel_links) > 0:
                    print("‚ö†Ô∏è Tam e≈üle≈üme yok, ilk sonu√ß se√ßiliyor")
                    parsel_links[0].click()
                
                time.sleep(2)
                
                # ƒ∞mar Durumu butonuna tƒ±kla
                print("üìã ƒ∞mar durumu a√ßƒ±lƒ±yor...")
                imar_button = page.locator(self.selectors['imar_button'])
                imar_button.wait_for(state='visible', timeout=10000)
                imar_button.click()
                time.sleep(3)
                
                # Yeni sekme kontrol√º
                all_pages = context.pages
                if len(all_pages) > 1:
                    page = all_pages[-1]
                    print("üìÑ Yeni sekme algƒ±landƒ±")
                
                page.wait_for_load_state('networkidle')
                time.sleep(2)
                
                # Sayfayƒ± parse et
                sonuc = self._parse_imar_durumu(page, ada, parsel)
                sonuc['success'] = True
                
                # Screenshot al
                screenshot_bytes = page.screenshot(full_page=True)
                sonuc['screenshot_base64'] = screenshot_bytes.hex()
                
                print("‚úÖ Sorgulama ba≈üarƒ±lƒ±!")
                return sonuc
                
            except PlaywrightTimeout as e:
                print(f"‚ùå Timeout: {e}")
                return {
                    'success': False,
                    'error': f'Timeout: {str(e)}',
                    'ada': ada,
                    'parsel': parsel
                }
            except Exception as e:
                print(f"‚ùå Hata: {e}")
                return {
                    'success': False,
                    'error': str(e),
                    'ada': ada,
                    'parsel': parsel
                }
            finally:
                browser.close()
    
    def _parse_imar_durumu(self, page, ada: str, parsel: str) -> Dict:
        """ƒ∞mar durumu bilgilerini √ßƒ±kar"""
        
        sonuc = {
            'ada': ada,
            'parsel': parsel,
            'il': 'Adana',
            'ilce': 'Seyhan',
            'imar_durumu': None,
            'kaks': None,
            'yapi_nizami': None,
            'yukseklik': None,
            'alan': None,
            'raw_html': page.content(),
            'diger_bilgiler': {}
        }
        
        try:
            # Tablolardan bilgi √ßek
            tables = page.locator('table').all()
            
            for table in tables:
                rows = table.locator('tr').all()
                for row in rows:
                    try:
                        cells = row.locator('td').all()
                        if len(cells) >= 2:
                            key = cells[0].inner_text().strip().lower()
                            value = cells[1].inner_text().strip()
                            
                            if 'imar' in key or 'durum' in key or 'fonksiyon' in key:
                                sonuc['imar_durumu'] = value
                            elif 'kaks' in key or 'emsal' in key:
                                sonuc['kaks'] = value
                            elif 'yapƒ±' in key and 'nizam' in key:
                                sonuc['yapi_nizami'] = value
                            elif 'y√ºkseklik' in key or 'kat' in key:
                                sonuc['yukseklik'] = value
                            elif 'alan' in key:
                                sonuc['alan'] = value
                            else:
                                sonuc['diger_bilgiler'][cells[0].inner_text().strip()] = value
                    except:
                        continue
            
        except Exception as e:
            print(f"‚ö†Ô∏è Parse hatasƒ±: {e}")
        
        return sonuc

# ==================== ROUTES ====================

@app.get("/")
async def root():
    """Health check"""
    return {
        "status": "ok",
        "service": "KEOS Seyhan API",
        "version": "1.0.0",
        "timestamp": datetime.utcnow().isoformat()
    }

@app.get("/health")
async def health():
    """Health check endpoint"""
    return {"status": "healthy"}

@app.post("/api/query/keos-seyhan")
async def query_keos_seyhan(request: QueryRequest):
    """
    KEOS Seyhan ada-parsel sorgusu
    
    Body:
    {
        "ada": "10568",
        "parsel": "9",
        "user_id": "optional_clerk_user_id"
    }
    """
    
    try:
        # Kullanƒ±cƒ± kredi kontrol√º (Supabase varsa)
        if request.user_id and SUPABASE_ENABLED and supabase:
            try:
                user_response = supabase.table('users').select('credits').eq('clerk_user_id', request.user_id).execute()
                
                if not user_response.data:
                    raise HTTPException(status_code=404, detail="Kullanƒ±cƒ± bulunamadƒ±")
                
                if user_response.data[0]['credits'] <= 0:
                    raise HTTPException(status_code=402, detail="Yetersiz kredi")
                
                # Kredi d√º≈ü
                supabase.table('users').update({
                    'credits': user_response.data[0]['credits'] - 1
                }).eq('clerk_user_id', request.user_id).execute()
                
            except HTTPException:
                raise
            except Exception as e:
                print(f"Supabase hatasƒ± (devam ediliyor): {e}")
        
        # KEOS Scraper ile sorgu
        scraper = KeosSeyhanScraper()
        result = scraper.sorgula(
            ada=request.ada,
            parsel=request.parsel
        )
        
        if not result.get('success'):
            return JSONResponse(
                status_code=400,
                content={
                    'success': False,
                    'error': result.get('error', 'Sorgulama ba≈üarƒ±sƒ±z')
                }
            )
        
        # Supabase'e kaydet (varsa)
        if request.user_id and SUPABASE_ENABLED and supabase:
            try:
                query_record = {
                    'user_id': request.user_id,
                    'il': 'Adana',
                    'ilce': 'Seyhan',
                    'ada': request.ada,
                    'parsel': request.parsel,
                    'raw_result': result,
                    'status': 'completed',
                    'created_at': datetime.utcnow().isoformat()
                }
                
                supabase.table('queries').insert(query_record).execute()
                print("‚úÖ Sorgu Supabase'e kaydedildi")
            except Exception as e:
                print(f"Supabase kayƒ±t hatasƒ± (devam ediliyor): {e}")
        
        return {
            'success': True,
            'data': result,
            'timestamp': datetime.utcnow().isoformat()
        }
        
    except HTTPException:
        raise
    except Exception as e:
        print(f"API Error: {e}")
        raise HTTPException(status_code=500, detail=str(e))

@app.post("/api/webhooks/clerk")
async def clerk_webhook(request: Request):
    """
    Clerk webhook endpoint
    Kullanƒ±cƒ± olu≈üturulduƒüunda Supabase'e kaydet
    """
    
    try:
        payload = await request.json()
        event_type = payload.get('type')
        
        print(f"üì• Clerk webhook: {event_type}")
        
        if event_type == 'user.created':
            user_data = payload.get('data', {})
            
            # Supabase'e kullanƒ±cƒ± ekle
            try:
                supabase.table('users').insert({
                    'clerk_user_id': user_data.get('id'),
                    'email': user_data.get('email_addresses', [{}])[0].get('email_address'),
                    'credits': 3,  # 3 √ºcretsiz sorgu
                    'created_at': datetime.utcnow().isoformat()
                }).execute()
                
                print(f"‚úÖ Kullanƒ±cƒ± olu≈üturuldu: {user_data.get('id')}")
                
            except Exception as e:
                print(f"‚ùå Supabase hatasƒ±: {e}")
        
        return {"status": "ok"}
        
    except Exception as e:
        print(f"Webhook hatasƒ±: {e}")
        return JSONResponse(status_code=500, content={"error": str(e)})

@app.get("/api/users/{user_id}/credits")
async def get_user_credits(user_id: str):
    """Kullanƒ±cƒ±nƒ±n kalan kredisini getir"""
    
    if not SUPABASE_ENABLED or not supabase:
        return JSONResponse(
            status_code=503,
            content={"error": "Supabase baƒülantƒ±sƒ± aktif deƒüil"}
        )
    
    try:
        response = supabase.table('users').select('credits').eq('clerk_user_id', user_id).execute()
        
        if not response.data:
            raise HTTPException(status_code=404, detail="Kullanƒ±cƒ± bulunamadƒ±")
        
        return {
            'user_id': user_id,
            'credits': response.data[0]['credits']
        }
        
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@app.get("/api/queries/history/{user_id}")
async def get_query_history(user_id: str, limit: int = 20):
    """Kullanƒ±cƒ±nƒ±n sorgu ge√ßmi≈üi"""
    
    if not SUPABASE_ENABLED or not supabase:
        return JSONResponse(
            status_code=503,
            content={"error": "Supabase baƒülantƒ±sƒ± aktif deƒüil"}
        )
    
    try:
        response = supabase.table('queries')\
            .select('*')\
            .eq('user_id', user_id)\
            .order('created_at', desc=True)\
            .limit(limit)\
            .execute()
        
        return {
            'user_id': user_id,
            'queries': response.data,
            'total': len(response.data)
        }
        
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

# Uvicorn run
if __name__ == "__main__":
    import uvicorn
    port = int(os.getenv("PORT", 8000))
    uvicorn.run(app, host="0.0.0.0", port=port)          'raw_result': result,
                    'status': 'completed',
                    'created_at': datetime.utcnow().isoformat()
                }
                
                supabase.table('queries').insert(query_record).execute()
            except Exception as e:
                print(f"Supabase kayƒ±t hatasƒ±: {e}")
        
        return {
            'success': True,
            'data': result,
            'timestamp': datetime.utcnow().isoformat()
        }
        
    except HTTPException:
        raise
    except Exception as e:
        print(f"API Error: {e}")
        raise HTTPException(status_code=500, detail=str(e))

@app.post("/api/webhooks/clerk")
async def clerk_webhook(request: Request):
    """
    Clerk webhook endpoint
    Kullanƒ±cƒ± olu≈üturulduƒüunda Supabase'e kaydet
    """
    
    try:
        payload = await request.json()
        event_type = payload.get('type')
        
        print(f"üì• Clerk webhook: {event_type}")
        
        if event_type == 'user.created':
            user_data = payload.get('data', {})
            
            # Supabase'e kullanƒ±cƒ± ekle
            try:
                supabase.table('users').insert({
                    'clerk_user_id': user_data.get('id'),
                    'email': user_data.get('email_addresses', [{}])[0].get('email_address'),
                    'credits': 3,  # 3 √ºcretsiz sorgu
                    'created_at': datetime.utcnow().isoformat()
                }).execute()
                
                print(f"‚úÖ Kullanƒ±cƒ± olu≈üturuldu: {user_data.get('id')}")
                
            except Exception as e:
                print(f"‚ùå Supabase hatasƒ±: {e}")
        
        return {"status": "ok"}
        
    except Exception as e:
        print(f"Webhook hatasƒ±: {e}")
        return JSONResponse(status_code=500, content={"error": str(e)})

@app.get("/api/users/{user_id}/credits")
async def get_user_credits(user_id: str):
    """Kullanƒ±cƒ±nƒ±n kalan kredisini getir"""
    
    try:
        response = supabase.table('users').select('credits').eq('clerk_user_id', user_id).execute()
        
        if not response.data:
            raise HTTPException(status_code=404, detail="Kullanƒ±cƒ± bulunamadƒ±")
        
        return {
            'user_id': user_id,
            'credits': response.data[0]['credits']
        }
        
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@app.get("/api/queries/history/{user_id}")
async def get_query_history(user_id: str, limit: int = 20):
    """Kullanƒ±cƒ±nƒ±n sorgu ge√ßmi≈üi"""
    
    try:
        response = supabase.table('queries')\
            .select('*')\
            .eq('user_id', user_id)\
            .order('created_at', desc=True)\
            .limit(limit)\
            .execute()
        
        return {
            'user_id': user_id,
            'queries': response.data,
            'total': len(response.data)
        }
        
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

# Uvicorn run
if __name__ == "__main__":
    import uvicorn
    port = int(os.getenv("PORT", 8000))
    uvicorn.run(app, host="0.0.0.0", port=port)
